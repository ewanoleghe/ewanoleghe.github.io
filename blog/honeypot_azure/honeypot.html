<!DOCTYPE html><html><head>
      <title>Ewan Oleghe | Cybersecurity Analyst</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\Omen\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.20\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<nav style="text-align:right; font-size:0.9rem; margin-bottom:20px;">
  <a href="../../index.html">Home</a> |
  <a href="../../blog.html">Blog</a> |
  <a href="../../contact.html">Contact</a> |
  <a href="../../resume.html" target="_blank">Resume</a>
</nav>
<hr>
<h1 id="azure-microsoft-sentinel-honeypot--attack-monitoring-lab"><strong>AZURE: Microsoft Sentinel Honeypot &amp; Attack Monitoring Lab</strong> </h1>
<h2 id="summary"><strong>Summary</strong> </h2>
<p>This project demonstrates the design and deployment of a cloud-based honeynet in <strong>Microsoft Azure</strong>, integrated with <strong>Microsoft Sentinel</strong> for real-time attack detection, threat intelligence enrichment, and global telemetry visualization.</p>
<p>A publicly exposed Windows VM was intentionally configured with weakened firewall and network security controls to attract real adversary activity from the internet. Logs were collected using the Azure Monitoring Agent and correlated within Sentinel for threat hunting, mapping attacker geolocation, and building security analytics.</p>
<p><em>Published on November 20, 2025 by <strong>Ewan Oleghe</strong>.</em></p>
<hr>
<h2 id="introduction"><strong>Introduction</strong> </h2>
<p>This hands-on security project focuses on building a realistic <strong>Security Operations Center (SOC) home lab</strong> using Azure services.<br>
The goal was to:</p>
<ul>
<li>Deploy a vulnerable Windows VM on Azure</li>
<li>Expose it to the internet to attract live attack traffic</li>
<li>Ingest logs into <strong>Log Analytics Workspace</strong></li>
<li>Enable <strong>Microsoft Sentinel</strong> to monitor, analyze, and visualize attacker behavior</li>
<li>Build custom KQL queries, alert rules, dashboards, and watchlists</li>
<li>Map global brute-force attempts using threat-intel and GEO-IP data</li>
</ul>
<p>The lab simulates real-world SOC workflows such as threat detection, log analysis, alerting, correlation, and visualization, allowing practical blue-team experience with Azure-native tools.</p>
<hr>
<h2 id="introduction-1"><strong>Introduction</strong> </h2>
<ul style="font-size:80%">
  <li>Set-up a New Azure account or</li>
  <li>Log-in to Azure portal : https://portal.azure.com/</li>
</ul>
<hr>
<h3 id="step-1-create-a-resource-group"><strong>Step 1: Create a Resource Group</strong> </h3>
<p>The local container that groups everything related to one project (e.g., VM, VNet, NIC, Public IP).</p>
<p><img src="image.png" alt="alt text"></p>
<ul style="font-size:80%">
  <li>Use the search bar or</li>
  <li>Select resource Groups in the Navigate section</li>
  <li>Create a Resource group
    <ul>
      <li>Subscription: Select your subscription</li>
      <li>Resource group: Name your resource group (e.g., H-SOC-Lab)</li>
      <li>Region: Select a region close to you (e.g., East US)</li>
      <li>Review and Create</li>
    </ul>
  </li>
</ul>
<h3 id="step-2-create-a-virtual-network-vnets"><strong>Step 2: Create a Virtual Network (VNets)</strong> </h3>
<p>The VNets a private, customizable network allows us to connect and secures resources. Our Virtual Machine will be placed inside the Virtual Network</p>
<ul style="font-size:80%">
  <li>Use the search bar or</li>
  <li>Select Virtual networks - under Services</li>
  <li>Create virtual network
    <ul>
      <li>Subscription: Select your subscription</li>
      <li>Resource group: H-SOC-Lab</li>
      <li>Virtual network name (e.g., VNet-SOC-Lab)</li>
      <li>Region: Select a region close to you (e.g., East US)</li>
      <li>Review and Create</li>
    </ul>
  </li>
</ul>
<h3 id="step-3-create-a-virtual-machine-vm"><strong>Step 3: Create a Virtual Machine (VM)</strong> </h3>
<p>In Microsoft Azure, a VM is a cloud-hosted computer - This is what will be exposed to the Internet/attackers.</p>
<ul style="font-size:80%">
  <li>Use the search bar or</li>
  <li>From the Home page, Select 'Virtual Machines' in Azure services section</li>
  <li>Create a Virtual Machine
    <ul>
      <li>Select Virtual Machine</li>
      <li>Resource group: H-SOC-Lab</li>
      <li>Virtual machine name: (e.g., CORP-US) - do not use honeypot- attachers can easily resolve the name to the IP</li>
      <li>Region: Select a region close to you (e.g., East US)</li>
      <li>Image: Windows 10 or 11 or any other Windows OS</li>
      <li>Size: (Chose a small machine to manage cost)</li>
      <li>check - confirm I have an eligible Windows 10/11 license</li>
      <li>-&gt; Next: Disk
        <ul>
        <li>OS disk type: Select a small disk or HDD</li>
        </ul>
      </li>
      <li>-&gt; Next: Networking
        <ul>
        <li>Virtual network: 'VNet-SOC-Lab'</li>
        <li>Subnet: 'default'</li>
        <li>Check: 'Delete public IP and NIC when VM is deleted'</li>
        </ul>
      </li>
      <li>-&gt; Next: Management</li>
      <li>-&gt; Next: Monitoring
      <ul>
        <li>Boot diagnostics - Check: 'Disable'</li>
        </ul>
        </li>
      <li>-&gt; Next: Advanced</li>
      <li>-&gt; Next: Review &amp; Create</li>
      <li>-&gt; Next: Create</li>
    </ul>
  </li>
</ul>
<p><img src="image-1.png" alt="alt text"></p>
<h3 id="step-4-configure-network-security-group-nsg-rules"><strong>Step 4: Configure Network Security Group (NSG) Rules</strong> </h3>
<p>The NSG acts as a virtual firewall to control inbound and outbound traffic to the VM. We will create rules to allow specific traffic to the honeypot VM.</p>
<ul style="font-size:80%">
  <li>Inbound Security rules: Delete the default RDP</li>
  <li>Set-up new traffic rule that allows inbound to all protocol
    <ul>
        <li>Go to Settings &gt; Inbound security rules &gt; + Add</li>
        <li>Source: Any</li>
        <li>Source port ranges: * (all)</li>
        <li>Destination: Any</li>
        <li>Service: Custom</li>
        <li>Destination port ranges: *</li>
        <li>Protocol: Any</li>
        <li>Action: Allow</li>
        <li>Priority: 100</li>
        <li>Name: Danger_vm_inboubd</li>
    </ul>
      </li>
</ul>
<h3 id="step-5-log-in-to-vm"><strong>Step 5: Log-in to VM</strong> </h3>
<ul style="font-size:80%">
  <li>RDP</li>
    <ul>
        <li>Log-in to VMM and disable the internal firewall on the VM</li>
        <li>Use RDP to login to the VM</li>
        <li>Primary NIC public IP: 20.64.238.22</li>
    </ul>
      
</ul>
<p><img src="image-2.png" alt="alt text"></p>
<p><img src="image-3.png" alt="alt text"></p>
<ul style="font-size:80%">
  <li>Turn off Windows Firewall</li>
    <ul>
        <li>on the Vm search for 'wf.msc</li>
    </ul>
      
</ul>
<p><img src="image-4.png" alt="alt text"></p>
<ul style="font-size:80%">
  <li>Click : Windows Defender Firewall Properties and Turn off Firewall for each profile (Domain, Private and Public profiles) </li>
 </ul>
<p><img src="image-5.png" alt="alt text"></p>
<p><img src="image-6.png" alt="alt text"></p>
<h3 id="ping-the-vm-to-local-computer"><strong>Ping the VM to local Computer</strong> </h3>
<p>From your local machine. Use CMD or PowerShell to ping the VM. We have to make sure its accessible on the internet.</p>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code>ping <span class="token operator">-</span>n 6 20<span class="token punctuation">.</span>64<span class="token punctuation">.</span>238<span class="token punctuation">.</span>22
</code></pre><p>Pings the VM and a total of 6 packets sent and received</p>
<p><img src="image-7.png" alt="alt text"></p>
<h3 id="step-6-set-up-log-analytics-workspace--microsoft-sentinel"><strong>Step 6: Set-up Log Analytics Workspace &amp; Microsoft Sentinel</strong> </h3>
<p>By default the VM keeps all the Security Events in 'Event Viewer' - Windows Logs - Security.<br>
<img src="image-8.png" alt="alt text"><br>
Each ID corresponds to a security events and an ID search can be used to filter logs (e.g. For failed logs search (Ctrl + F or 'Filter current log..') for '4625')</p>
<p><strong>Configure a Log Repository</strong><br>
To collect and analyze these logs in Microsoft Sentinel, we need to set up a Log Analytics Workspace and enable Microsoft Sentinel (SIEM).</p>
<ul style="font-size:80%">
  <li>AZURE: Create 'Log Analytics workspace'</li>
    <ul>
        <li>Resource group: H-SOC-Lab</li>
        <li>Name: Log-SOC-lab</li>
        <li>Region: East US 2</li>
        <li>Review &amp; Create</li>
    </ul>
      
</ul>
<p><strong>Create Microsoft Sentinel Instance</strong></p>
<ul style="font-size:80%">
  <li>AZURE: Create 'Microsoft Sentinel'</li>
    <ul>
        <li>Select the Log Analytics workspace: Log-SOC-lab</li>
        <li>Add</li>
    </ul>
      
</ul>
<p><strong>Configure the Connection between VM and Log Analytics</strong></p>
<ul style="font-size:80%">
  <li>AZURE: 'Microsoft Sentinel'</li>
    <ul>
        <li>Content Management</li>
        <li>Content Hub</li>
        <li>Search: Windows Security Events</li>
        <li>Select &amp; Install: Windows Security Events</li>
    </ul>
      
</ul>
<p><img src="image-9.png" alt="alt text"></p>
<p><strong>Manage Windows Security Events via Azure Monitoring Agent (AMA)</strong></p>
<ul style="font-size:80%">
  <li>AZURE: 'Microsoft Sentinel'</li>
    <ul>
        <li>Configuration</li>
        <li>Click on Manage - Windows Security Events</li>
        <li>Check and Install the Windows Security Events via AMA</li>
    </ul>
      
</ul>
<p><img src="image-10.png" alt="alt text"></p>
<ul style="font-size:80%">
  <li>AZURE: 'Microsoft Sentinel': Windows Security Events via AMA</li>
    <ul>
        <li>Open connector page</li>
        <li>+Create data collection rule</li>
        <li>Check and Install the Windows Security Events via AMA
        <ul>
            <li>Configuration</li>
            <li>Rule name: Mag-Windows</li>
            <li>Resource group: H-SOC-Lab</li>
        </ul></li>
        <li>Next: Resources<ul>
            <li>Expand 'Azure Subscription, then RG and select the resource group and VM</li>
        </ul></li>
        <li>Next: Collect all security events</li>
        <li>Next: &amp; Create</li>
    </ul>
      
</ul>
<p><img src="image-12.png" alt="alt text"></p>
<h3 id="step-7-monitor-attacks-in-microsoft-sentinel"><strong>Step 7: Monitor Attacks in Microsoft Sentinel</strong> </h3>
<ul style="font-size:80%">
  <li>AZURE: 'Log Analytics workspaces'</li>
    <ul>
        <li>Select the Sentinel : Log-SOC-lab</li>
        <li>Select: Logs &gt; Table &gt; SecurityEvents</li>
        <li>To Use KQL queries: Logs &gt; Queries &gt; (top right: change from User Mode to KQL mode)</li>
    </ul>
      
</ul>
<p><img src="image-13.png" alt="alt text"></p>
<h3 id="example-kql-queries-to-monitor-attacks"><strong>Example KQL Queries to Monitor Attacks</strong> </h3>
<pre data-role="codeBlock" data-info="kql" class="language-kql kql"><code>// Failed RDP Log-in Attempts (Event ID: 4625)
SecurityEvent
| where EventID == 4625
| summarize Count = count() by Account, IpAddress, bin(TimeGenerated, 1h)
| order by Count desc
</code></pre><pre data-role="codeBlock" data-info="kql" class="language-kql kql"><code>// All RDP Log-in Attempts (Successful and Failed)
SecurityEvent
| where EventID in (4624, 4625)
</code></pre><pre data-role="codeBlock" data-info="kql" class="language-kql kql"><code>// Targeted Specific Account e.g. "administrator "
SecurityEvent
| where Account == "\\administrator"
</code></pre><pre data-role="codeBlock" data-info="kql" class="language-kql kql"><code>// Top Targeted Accounts by Failed Log-ins
SecurityEvent
| where EventID == 4625
| summarize FailedAttempts = count() by Account
| order by FailedAttempts desc
</code></pre><pre data-role="codeBlock" data-info="kql" class="language-kql kql"><code>// Successful RDP Log-in Attempts (Event ID: 4624)
SecurityEvent
| where EventID == 4624
| summarize Count = count() by Account, IpAddress, bin(TimeGenerated, 1h)
| order by Count desc
</code></pre><pre data-role="codeBlock" data-info="kql" class="language-kql kql"><code>// Top Source IPs by Failed Log-ins
SecurityEvent
| where EventID == 4625
| summarize FailedAttempts = count() by IpAddress
| order by FailedAttempts desc
| take 10
</code></pre><pre data-role="codeBlock" data-info="kql" class="language-kql kql"><code>// Brute-force Attack Patterns
SecurityEvent
| where EventID == 4625
| summarize Attempts = count() by IpAddress, bin(TimeGenerated, 10m)
| where Attempts &gt; 5
| order by Attempts desc
</code></pre><pre data-role="codeBlock" data-info="kql" class="language-kql kql"><code>// Geo-location of Attackers
SecurityEvent
| where EventID == 4625
| extend GeoInfo = iplocation(IpAddress)
| summarize Count = count() by GeoInfo.CountryOrRegion
| order by Count desc
</code></pre><p><strong>Geo-location of Attackers</strong></p>
<ul style="font-size:80%">
  <li>Add Geographic Data to resolve IpAddresses to Physical Location</li>
  <li> Import a spreadsheet which contains geographic information for each block of IP addresses (as a "Sentinel Watchlist").
<p>Download: <a herf="https://raw.githubusercontent.com/joshmadakor1/lognpacific-public/refs/heads/main/misc/geoip-summarized.csv" target="_blank" href=""> geoip-summarized.csv</a></p>
</li>
  <li>Azure: search: Microsoft Sentinel &gt; select: Configuration &gt; select:  watchlist &gt; + New</li>
  <li>Watchlist wizard - General
    <ul>
      <li>Name: geoip</li>
      <li>Alias: geoip</li>
    </ul>
  </li>
  <li>Watchlist wizard - Source
    <ul>
      <li>Source type: local file</li>
      <li>File type: csv with header</li>
      <li>Upload file: upload the downloaded file 'geoip-summarized.csv'</li>
      <li>SearchKey: network</li>
      <li>Review &amp; Create</li>
    </ul>
  </li>
</ul>
- to see our uploaded watchlist using kql
<pre data-role="codeBlock" data-info="kql" class="language-kql kql"><code>_GetWatchlist("geoip")
</code></pre><p><strong>See where the attacks are coming from</strong></p>
<pre data-role="codeBlock" data-info="kql" class="language-kql kql"><code>let GeoIPDB_FULL = _GetWatchlist("geoip");
let WindowsEvents = SecurityEvent
    | where IpAddress == &lt;attacker IP address&gt; // Replace Ip address "147.91.111.100"
    | where EventID == 4625
    | order by TimeGenerated desc
    | evaluate ipv4_lookup(GeoIPDB_FULL, IpAddress, network);
WindowsEvents

</code></pre><h2 id="attack-map-creation">Attack Map Creation </h2>
<ul style="font-size:80%">
  <li>AZURE: 'Create Sentinel Workbook'</li>
    <ul>
        <li>Select the Sentinel : Log-SOC-lab &gt; Threat Management &gt; Workbooks &gt; + Add Workbook &gt; Edit &gt; (use 3 dots to remove all content)</li>
    </ul>
      
  <li>Add &gt; add query &gt; Advanced editor (delete and paste the json code below) &gt; Done editing</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
	<span class="token property">"type"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
	<span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
	<span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"KqlItem/1.0"</span><span class="token punctuation">,</span>
	<span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"let GeoIPDB_FULL = _GetWatchlist(\"geoip\");\nlet WindowsEvents = SecurityEvent;\nWindowsEvents | where EventID == 4625\n| order by TimeGenerated desc\n| evaluate ipv4_lookup(GeoIPDB_FULL, IpAddress, network)\n| summarize FailureCount = count() by IpAddress, latitude, longitude, cityname, countryname\n| project FailureCount, AttackerIp = IpAddress, latitude, longitude, city = cityname, country = countryname,\nfriendly_location = strcat(cityname, \" (\", countryname, \")\");"</span><span class="token punctuation">,</span>
	<span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
	<span class="token property">"timeContext"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"durationMs"</span><span class="token operator">:</span> <span class="token number">2592000000</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">"queryType"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token property">"resourceType"</span><span class="token operator">:</span> <span class="token string">"microsoft.operationalinsights/workspaces"</span><span class="token punctuation">,</span>
	<span class="token property">"visualization"</span><span class="token operator">:</span> <span class="token string">"map"</span><span class="token punctuation">,</span>
	<span class="token property">"mapSettings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"locInfo"</span><span class="token operator">:</span> <span class="token string">"LatLong"</span><span class="token punctuation">,</span>
		<span class="token property">"locInfoColumn"</span><span class="token operator">:</span> <span class="token string">"countryname"</span><span class="token punctuation">,</span>
		<span class="token property">"latitude"</span><span class="token operator">:</span> <span class="token string">"latitude"</span><span class="token punctuation">,</span>
		<span class="token property">"longitude"</span><span class="token operator">:</span> <span class="token string">"longitude"</span><span class="token punctuation">,</span>
		<span class="token property">"sizeSettings"</span><span class="token operator">:</span> <span class="token string">"FailureCount"</span><span class="token punctuation">,</span>
		<span class="token property">"sizeAggregation"</span><span class="token operator">:</span> <span class="token string">"Sum"</span><span class="token punctuation">,</span>
		<span class="token property">"opacity"</span><span class="token operator">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span>
		<span class="token property">"labelSettings"</span><span class="token operator">:</span> <span class="token string">"friendly_location"</span><span class="token punctuation">,</span>
		<span class="token property">"legendMetric"</span><span class="token operator">:</span> <span class="token string">"FailureCount"</span><span class="token punctuation">,</span>
		<span class="token property">"legendAggregation"</span><span class="token operator">:</span> <span class="token string">"Sum"</span><span class="token punctuation">,</span>
		<span class="token property">"itemColorSettings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"nodeColorField"</span><span class="token operator">:</span> <span class="token string">"FailureCount"</span><span class="token punctuation">,</span>
		<span class="token property">"colorAggregation"</span><span class="token operator">:</span> <span class="token string">"Sum"</span><span class="token punctuation">,</span>
		<span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"heatmap"</span><span class="token punctuation">,</span>
		<span class="token property">"heatmapPalette"</span><span class="token operator">:</span> <span class="token string">"greenRed"</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"query - 0"</span>
<span class="token punctuation">}</span>
</code></pre><ul>
<li>
<p>Paste the json code inside the query window</p>
</li>
<li>
<p>Save the Map generated</p>
</li>
</ul>
<p><img src="image-14.png" alt="alt text"></p>
<h3 id="step-8-visualize-attacks-with-dashboards"><strong>Step 8: Visualize Attacks with Dashboards</strong> </h3>
<hr>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>